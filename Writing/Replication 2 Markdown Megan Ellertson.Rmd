---
title: "Replication 2 Megan Ellertson"
author: "Megan Ellertson"
date: "4/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Replication 2
```{r}
library(tidyverse)
library(haven)
```
*The data combined was completed in STATA then brought into R for quicker computation. See the following STATA syntax, which was used to create the combined and used data set for the analysis.*
```{stata}
use https://github.com/scunning1975/mixtape/raw/master/nsw_mixtape.dta, clear
drop if treat==0
append using https://github.com/scunning1975/mixtape/raw/master/cps_mixtape.dta
```

```{r}
read_data <- function(df)
{
  full_path <- paste("https://raw.github.com/scunning1975/mixtape/master/", 
                     df, sep = "")
  df <- read_dta(full_path)
  return(df)
  dataset <- read_dta("Data/combineddata.dta")
}

```

```{r}
nsw_dw_cpscontrol <- dataset %>% 
  mutate(agesq = age^2,
         agecube = age^3,
         educsq = educ*educ,
         u74 = case_when(re74 == 0 ~ 1, TRUE ~ 0),
         u75 = case_when(re75 == 0 ~ 1, TRUE ~ 0),
         interaction1 = educ*re74,
         re74sq = re74^2,
         re75sq = re75^2,
         interaction2 = u74*hisp)
#Creating logit data 
nsw_dw_cpscontrol_logit <- nsw_dw_cpscontrol %>%
  mutate(educcube = educ^3,
         re74cube=re74^3, 
         re75cube=re75^3)
#Creating ols data
nsw_dw_cpscontrol_ols <- nsw_dw_cpscontrol %>%
  mutate(re74quad = re74^4,
         re75quad = re74^4)
```

1. 
a. The following equations are for the logit and OLS versions of the basic equation provided in the mixtape nsq_pscore.do. This expands off the basic logit provided. 
$$logit(treat)= age + age^2 + age^3 + educ + educ^2 + + educ^3 +marr + nodegree + black + 
hisp + re74 + re74^2 + re74^3 + re75 + re75^2 + re75^3 + u74 + u75 + educ*hisp + \epsilon$$
```{r}
logit_nsw_adv <- glm(treat ~ age + agesq + agecube + educ + educsq
                     + educcube + marr + nodegree
                     + black + hisp + re74 + re74sq + re74cube 
                     + re75 + re75sq + re75cube + u74 + u75 +
                       interaction1, family = binomial(link =
                      "logit"), data = nsw_dw_cpscontrol_logit)
```
$$ols(treat) = age + age^2 + educ + educ^2 + marr + nodegree + black + 
hisp + re74 + re74^2 + re75 + re75^2 + u74 + u75 + educ*hisp + \epsilon$$

```{r}
ols_nsw_adv <- lm(treat ~ age + agesq + agecube + educ + marr + 
                    nodegree+ black + hisp + re74 + re74sq
                     + re75 + re75sq + u74 + u75 + interaction1,
                  data = nsw_dw_cpscontrol_ols)
```
*include table with ols and logit output*
```{r}
nsw_dw_cpscontrol_logit <- nsw_dw_cpscontrol_logit %>% 
  mutate(pscore = logit_nsw_adv$fitted.values)


nsw_dw_cpscontrol_ols <- nsw_dw_cpscontrol_ols %>% 
  mutate(pscore = ols_nsw_adv$fitted.values)
```


```{r}
pscore_control_logit <- nsw_dw_cpscontrol_logit %>%
  filter(treat==0) %>%
  pull(pscore) %>%
  mean()
pscore_control_logit <- nsw_dw_cpscontrol_logit %>%
  filter(treat==1) %>%
  pull(pscore) %>%
  mean()

pscore_control_ols <- nsw_dw_cpscontrol_ols %>%
  filter(treat==0) %>%
  pull(pscore) %>%
  mean()
pscore_control_ols <- nsw_dw_cpscontrol_ols %>%
  filter(treat==1) %>%
  pull(pscore) %>%
  mean()
```

```{r}
nsw_dw_cpscontrol_logit %>% 
  filter(treat == 0) %>% 
  ggplot() +
  geom_histogram(aes(x = pscore))

nsw_dw_cpscontrol_logit %>% 
  filter(treat == 1) %>% 
  ggplot() +
  geom_histogram(aes(x = pscore))

nsw_dw_cpscontrol_ols %>% 
  filter(treat == 0) %>% 
  ggplot() +
  geom_histogram(aes(x = pscore))

nsw_dw_cpscontrol_ols %>% 
  filter(treat == 1) %>% 
  ggplot() +
  geom_histogram(aes(x = pscore))
```


```{r}
nsw_dw_cpscontrol_logit <- nsw_dw_cpscontrol_logit %>% 
  filter(!(pscore >= 0.9)) %>% 
  filter(!(pscore <= 0.1))

Nl <- nrow(nsw_dw_cpscontrol_logit)

nsw_dw_cpscontrol_ols <- nsw_dw_cpscontrol_ols %>% 
  filter(!(pscore >= 0.9)) %>% 
  filter(!(pscore <= 0.1))

No <- nrow(nsw_dw_cpscontrol_ols)
```

```{r}
## Redo means
pscore_control_logit <- nsw_dw_cpscontrol_logit %>%
  filter(treat==0) %>%
  pull(pscore) %>%
  mean()
pscore_control_logit <- nsw_dw_cpscontrol_logit %>%
  filter(treat==1) %>%
  pull(pscore) %>%
  mean()

pscore_control_ols <- nsw_dw_cpscontrol_ols %>%
  filter(treat==0) %>%
  pull(pscore) %>%
  mean()
pscore_control_ols <- nsw_dw_cpscontrol_ols %>%
  filter(treat==1) %>%
  pull(pscore) %>%
  mean()
```

```{r}
## Redo Histograms

nsw_dw_cpscontrol_logit %>% 
  filter(treat == 0) %>% 
  ggplot() +
  geom_histogram(aes(x = pscore))

nsw_dw_cpscontrol_logit %>% 
  filter(treat == 1) %>% 
  ggplot() +
  geom_histogram(aes(x = pscore))

nsw_dw_cpscontrol_ols %>% 
  filter(treat == 0) %>% 
  ggplot() +
  geom_histogram(aes(x = pscore))

nsw_dw_cpscontrol_ols %>% 
  filter(treat == 1) %>% 
  ggplot() +
  geom_histogram(aes(x = pscore))
```

```{r}
#- Manual with non-normalized weights using trimmed data Logit
nsw_dw_cpscontrol_logit <- nsw_dw_cpscontrol_logit %>% 
  mutate(d1 = treat/pscore,
         d0 = (1-treat)/(1-pscore))

s1 <- sum(nsw_dw_cpscontrol_logit$d1)
s0 <- sum(nsw_dw_cpscontrol_logit$d0)

nsw_dw_cpscontrol_logit <- nsw_dw_cpscontrol_logit %>% 
  mutate(y1 = treat * re78/pscore,
         y0 = (1-treat) * re78/(1-pscore),
         ht = y1 - y0)

#- Manual with normalized weights with trimmed data
nsw_dw_cpscontrol_logit <- nsw_dw_cpscontrol_logit %>% 
  mutate(y1 = (treat*re78/pscore)/(s1/Nl),
         y0 = ((1-treat)*re78/(1-pscore))/(s0/Nl),
         norm = y1 - y0)

nsw_dw_cpscontrol_logit %>% 
  pull(ht) %>% 
  mean()

nsw_dw_cpscontrol_logit %>% 
  pull(norm) %>% 
  mean()
```

```{r}
#- Manual with non-normalized weights using trimmed data OLS
nsw_dw_cpscontrol_ols <- nsw_dw_cpscontrol_ols %>% 
  mutate(d1 = treat/pscore,
         d0 = (1-treat)/(1-pscore))

s1 <- sum(nsw_dw_cpscontrol_ols$d1)
s0 <- sum(nsw_dw_cpscontrol_ols$d0)

nsw_dw_cpscontrol_ols <- nsw_dw_cpscontrol_ols %>% 
  mutate(y1 = treat * re78/pscore,
         y0 = (1-treat) * re78/(1-pscore),
         ht = y1 - y0)

#- Manual with normalized weights with trimmed data
nsw_dw_cpscontrol_ols <- nsw_dw_cpscontrol_ols %>% 
  mutate(y1 = (treat*re78/pscore)/(s1/No),
         y0 = ((1-treat)*re78/(1-pscore))/(s0/No),
         norm = y1 - y0)

nsw_dw_cpscontrol_ols %>% 
  pull(ht) %>% 
  mean()

nsw_dw_cpscontrol_ols %>% 
  pull(norm) %>% 
  mean()
```

